<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>農業重點關鍵字雲</title>
  <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/plugins/wordCloud.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden; /* 避免捲軸 */
      font-family: Arial, sans-serif;
      background: linear-gradient(197deg, #3ccfbc 0%, #0156cd 100%);
    }

    /* 外層容器，左右兩區塊 */
    .container {
      display: flex;
      width: 100%;
      height: 85vh; /* 佔滿整個視窗高度 */
    }

    /* 左側文字雲 */
    .left {
      flex: 4;
      display: flex;
      flex-direction: column;
      border-top: 5px solid #ffffff;
    }

    /* amCharts 文字雲容器 */
    #chartdiv {
      flex: 1;
      width: 100%;
    }

    /* 右側文字 + 圖片 */
    .right {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* 文字在上、圖片在下 */
      padding: 20px;
      box-sizing: border-box;
      border: 5px solid #ffffff; /* 白色邊框 */
    }

    .right-text {
      font-size: 32px;
      color: #ffffff;
    }

    .right-image {
      width: 80%;
      display: flex;
      align-self: center;  /* 靠右 */
      margin-bottom: 30px;   /* 與底部留距離 */

    }

    .right-image img {
      max-width: 100%;
      height: auto;
    }
    h1 {
      text-align: center;
      padding-top: 1%;
      font-size: 60px;
      color: #ffffff;
      text-shadow: 2px 4px 12px rgba(0,0,0,0.18), 0 1px 0 #fff;
      animation: h1-glow 2.5s ease-in-out infinite alternate;
    }

  </style>
</head>
<body>
  <h1>農業重點關鍵字雲</h1>
  <div class="container">
    
    <!-- 左側文字雲 -->
    <div class="left">
      <div id="chartdiv"></div>
    </div>

    <!-- 右側文字與圖片 -->
    <div class="right">
      <div class="right-text">
      掃描QRcode，填寫3個對於「人工智慧（AI）在農業應用」的第一印象或最關注的議題

      </div>
      <div class="right-image">
        <img src="wordcloud-qr-code.png" alt="右下角圖片">
      </div>
    </div>
  </div>

  <script>
    const SHEET_URL =
      "https://docs.google.com/spreadsheets/d/1xPXe4CnkArTB6bPoCnfqXeKAhvginDJ0Caakyv3fr3E/gviz/tq?tqx=out:json&tq=select%20F,G";

    am4core.useTheme(am4themes_animated);

    // 建立 WordCloud 圖表
    let chart = am4core.create("chartdiv", am4plugins_wordCloud.WordCloud);
    let series = chart.series.push(new am4plugins_wordCloud.WordCloudSeries());

    // 欄位對應
    series.dataFields.word = "word";
    series.dataFields.value = "weight";

    // 所有文字水平排列
    series.angles = [0];
    series.rotationThreshold = 1;
    series.randomness = 0.3; // 文字隨機程度
    series.accuracy = 1;

    // 顏色設定
    series.colors = new am4core.ColorSet();
    series.colors.list = [
      am4core.color("#FFD7C2"), // 淺橘
      am4core.color("#FFF3B0"), // 淺黃
      am4core.color("#B9FBC0"), // 淺綠
      am4core.color("#A0E7FF"), // 淺藍
      am4core.color("#E3D0FF")  // 淺紫
    ];
    series.colors.passOptions = {};
    series.colors.reuse = true;


    // 樣式設定
    series.labels.template.tooltipText = "{word}: {value}";
    series.fontFamily = "Arial";
    series.minFontSize = 12;
    series.maxFontSize = 80;

    // 紀錄上一筆資料
    let lastData = [];

    async function fetchWords() {
      try {
        const response = await fetch(SHEET_URL);
        const text = await response.text();

        // 解析 Google Sheets JSON
        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
        if (!match) throw new Error("無法解析 Google Sheets JSON");
        const json = JSON.parse(match[1]);

        // 假設 F欄=文字，G欄=權重
        const wordList = json.table.rows
          .map(r => {
            const word = r.c[0]?.v;
            const weight = parseInt(r.c[1]?.v || 10);
            return word ? { word, weight } : null;
          })
          .filter(Boolean);

        // 如果資料完全相同，跳過更新
        if (JSON.stringify(wordList) === JSON.stringify(lastData)) {
          console.log("資料未變，跳過更新");
          return;
        }

        // 資料筆數相同 → 平滑更新
        if (series.data.length === wordList.length) {
          series.data.forEach((item, idx) => {
            item.word = wordList[idx].word;
            item.weight = wordList[idx].weight;
          });
          series.invalidateRawData();
          console.log("資料筆數相同 → 平滑更新");
        } else {
          // 筆數不同 → 重建資料
          series.data = wordList;
          console.log("資料筆數不同 → 完整重建");
        }

        // 更新最後資料
        lastData = wordList;

      } catch (e) {
        console.error("讀取或解析失敗：", e);
      }
    }

    // 初次載入 & 每 3 秒更新
    fetchWords();
    setInterval(fetchWords, 3000);
  </script>
</body>
</html>
