<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>農業重點關鍵字雲</title>
  <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/plugins/wordCloud.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
  <style>
    #chartdiv {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <h2>農業重點關鍵字雲</h2>
  <div id="chartdiv"></div>

  <script>
    const SHEET_URL =
      "https://docs.google.com/spreadsheets/d/1xPXe4CnkArTB6bPoCnfqXeKAhvginDJ0Caakyv3fr3E/gviz/tq?tqx=out:json&tq=select%20F,G";

    am4core.useTheme(am4themes_animated);

    // 建立 WordCloud 圖表
    let chart = am4core.create("chartdiv", am4plugins_wordCloud.WordCloud);
    let series = chart.series.push(new am4plugins_wordCloud.WordCloudSeries());

    // 欄位對應
    series.dataFields.word = "word";
    series.dataFields.value = "weight";

    // 所有文字水平排列
    series.angles = [0];
    series.rotationThreshold = 1;
    series.randomness = 0.1;
    series.accuracy = 5;

    // 顏色設定
    series.colors = new am4core.ColorSet();
    series.colors.list = [
      am4core.color("#ff8a65"),
      am4core.color("#fbc02d"),
      am4core.color("#4caf50"),
      am4core.color("#42a5f5"),
      am4core.color("#7e57c2")
    ];
    series.colors.passOptions = {};
    series.colors.reuse = true;

    // 樣式設定
    series.labels.template.tooltipText = "{word}: {value}";
    series.fontFamily = "Arial";
    series.minFontSize = 12;
    series.maxFontSize = 80;

    // 紀錄上一筆資料
    let lastData = [];

    async function fetchWords() {
      try {
        const response = await fetch(SHEET_URL);
        const text = await response.text();

        // 解析 Google Sheets JSON
        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
        if (!match) throw new Error("無法解析 Google Sheets JSON");
        const json = JSON.parse(match[1]);

        // 假設 F欄=文字，G欄=權重
        const wordList = json.table.rows
          .map(r => {
            const word = r.c[0]?.v;
            const weight = parseInt(r.c[1]?.v || 10);
            return word ? { word, weight } : null;
          })
          .filter(Boolean);

        // 如果資料完全相同，跳過更新
        if (JSON.stringify(wordList) === JSON.stringify(lastData)) {
          console.log("資料未變，跳過更新");
          return;
        }

        // 資料筆數相同 → 平滑更新
        if (series.data.length === wordList.length) {
          series.data.forEach((item, idx) => {
            item.word = wordList[idx].word;
            item.weight = wordList[idx].weight;
          });
          series.invalidateRawData();
          console.log("資料筆數相同 → 平滑更新");
        } else {
          // 筆數不同 → 重建資料
          series.data = wordList;
          console.log("資料筆數不同 → 完整重建");
        }

        // 更新最後資料
        lastData = wordList;

      } catch (e) {
        console.error("讀取或解析失敗：", e);
      }
    }

    // 初次載入 & 每 3 秒更新
    fetchWords();
    setInterval(fetchWords, 3000);
  </script>
</body>
</html>
